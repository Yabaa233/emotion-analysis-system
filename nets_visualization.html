<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Java NETS 异常检测可视化</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .chart-container {
            width: 100%;
            height: 500px;
            margin: 20px 0;
        }
        .info-panel {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            border-left: 4px solid #4CAF50;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .controls-panel {
            background: #fff3e0;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px solid #ff9800;
        }
        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .control-item {
            display: flex;
            flex-direction: column;
        }
        .control-item label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }
        .control-item input, .control-item select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        .btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #ff5252;
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .loading {
            color: #ff9800;
            font-style: italic;
        }
        .result-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Java NETS 异常检测结果可视化</h1>
        
        <div class="info-panel">
            <h3>📊 测试数据说明</h3>
            <p><strong>数据类型:</strong> 500个点的标准正态分布 (均值=0, 标准差=1)</p>
            <p><strong>手动异常点:</strong> 在位置 100, 200, 300 添加了 +5 的显著异常值</p>
            <p><strong>当前参数:</strong> <span id="currentParams">R=0.1, K=8, W=500</span></p>
        </div>

        <div class="controls-panel">
            <h3>🔧 NETS参数调整</h3>
            <div class="control-group">
                <div class="control-item">
                    <label for="datasetSize">数据集大小</label>
                    <select id="datasetSize">
                        <option value="500">小数据集 (500点) - 测试模式</option>
                        <option value="5000">中等数据集 (5000点)</option>
                        <option value="17952">大数据集 (17952点) - 类似GSR数据</option>
                    </select>
                </div>
                <div class="control-item">
                    <label for="rValue">R值 (距离阈值) - 越小越严格</label>
                    <input type="number" id="rValue" min="0.01" max="1.0" step="0.01" value="0.1">
                    <small>推荐: 0.05-0.3</small>
                </div>
                <div class="control-item">
                    <label for="kValue">K值 (邻域阈值) - 越小越敏感</label>
                    <input type="number" id="kValue" min="1" max="50" step="1" value="8">
                    <small>推荐: 3-15</small>
                </div>
                <div class="control-item">
                    <label for="wValue">W值 (窗口大小)</label>
                    <input type="number" id="wValue" min="100" max="3000" step="50" value="500">
                    <small>推荐: 200-2000</small>
                </div>
                <div class="control-item">
                    <label for="presetParams">快速预设</label>
                    <select id="presetParams">
                        <option value="">选择预设参数...</option>
                        <option value="0.1,8,500" selected>推荐平衡 (R=0.1, K=8)</option>
                        <option value="0.03,3,400">极高敏感 (R=0.03, K=3)</option>
                        <option value="0.05,5,400">超高敏感 (R=0.05, K=5)</option>
                        <option value="0.08,6,400">高敏感 (R=0.08, K=6)</option>
                        <option value="0.15,10,500">中等敏感 (R=0.15, K=10)</option>
                        <option value="0.2,12,500">低敏感 (R=0.2, K=12)</option>
                    </select>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button id="runDetection" class="btn">🚀 运行NETS检测</button>
                <button id="resetParams" class="btn" style="background: #666;">重置参数</button>
                <button id="testLargeDataset" class="btn" style="background: #ff9800;">🔍 测试大数据集</button>
            </div>
            
            <div id="detectionStatus" style="margin-top: 15px; text-align: center;"></div>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div class="stat-value" id="anomalyCount">52</div>
                <div class="stat-label">检测到异常点</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="anomalyRate">10.4%</div>
                <div class="stat-label">异常率</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="manualDetected">1/3</div>
                <div class="stat-label">手动异常点识别</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="detectionTime">0.14s</div>
                <div class="stat-label">检测用时</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="anomalyChart"></canvas>
        </div>

        <div class="info-panel">
            <h3>🎯 检测结果分析</h3>
            <p><strong>✅ 成功检测:</strong> 所有3个手动异常点都在其附近25个索引范围内被检测到</p>
            <p><strong>📈 分布均匀:</strong> 异常点在整个时间序列中分布相对均匀</p>
            <p><strong>🔧 参数优化:</strong> R=0.1, K=8的组合提供了良好的敏感度平衡</p>
        </div>
    </div>

    <script>
        // 全局变量
        let chart;
        let currentTestData = [];
        let currentDetectionResult = null;
        const API_URL = 'http://localhost:5001';

        // 生成不同大小的测试数据
        function generateTestDataBySize(size) {
            const data = [];
            
            if (size <= 1000) {
                // 小数据集：标准正态分布 + 手动异常点
                for (let i = 0; i < size; i++) {
                    let u1 = Math.random();
                    let u2 = Math.random();
                    let normal = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    
                    // 在特定位置添加异常值
                    if (i === 100 || i === 200 || i === 300) {
                        normal += 5; // 添加+5的异常
                    }
                    
                    data.push(normal);
                }
            } else {
                // 大数据集：模拟GSR情感数据
                for (let i = 0; i < size; i++) {
                    // 基础信号：低频波动
                    let baseSignal = 0.5 * Math.sin(i * 0.001) + 0.3 * Math.sin(i * 0.003);
                    let noise = (Math.random() - 0.5) * 0.2;
                    data.push(baseSignal + noise);
                }
                
                // 添加模拟的情感响应事件
                const emotionEvents = [
                    Math.floor(size * 0.1),
                    Math.floor(size * 0.3),
                    Math.floor(size * 0.45),
                    Math.floor(size * 0.6),
                    Math.floor(size * 0.8),
                    Math.floor(size * 0.95)
                ];
                
                emotionEvents.forEach(pos => {
                    if (pos < size) {
                        // 创建GSR峰值
                        for (let offset = -5; offset <= 5; offset++) {
                            if (pos + offset >= 0 && pos + offset < size) {
                                data[pos + offset] += 0.8 * Math.exp(-Math.abs(offset) * 0.5);
                            }
                        }
                    }
                });
                
                console.log(`生成${size}点大数据集，情感事件位置:`, emotionEvents);
            }
            
            return data;
        }

        // 大数据集测试
        async function testLargeDataset() {
            const statusDiv = document.getElementById('detectionStatus');
            const testBtn = document.getElementById('testLargeDataset');
            
            try {
                statusDiv.innerHTML = '<div class="loading">🔄 生成大数据集并测试...</div>';
                testBtn.disabled = true;

                // 生成17952个数据点（类似GSR数据）
                const largeData = generateTestDataBySize(17952);
                
                statusDiv.innerHTML = '<div class="loading">🔄 调用NETS API检测 (大数据集)...</div>';

                const startTime = Date.now();

                const response = await fetch(`${API_URL}/nets/java/detect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: largeData,
                        params: {
                            // 让API自动选择大数据集参数
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API错误: ${response.status}`);
                }

                const result = await response.json();
                const endTime = Date.now();
                const executionTime = ((endTime - startTime) / 1000).toFixed(2);

                if (result.status === 'success') {
                    // 显示结果
                    const anomalyCount = result.outlier_count || 0;
                    const anomalyRate = (result.anomaly_rate || 0).toFixed(1);
                    
                    let statusMessage = `<div class="result-info">
                        ✅ 大数据集检测完成!<br>
                        📊 数据点: 17952个<br>
                        🎯 异常点: ${anomalyCount}个 (${anomalyRate}%)<br>
                        ⏱️ 用时: ${executionTime}s<br>
                        📈 参数: ${JSON.stringify(result.parameters)}
                    </div>`;

                    if (anomalyCount > 10) {
                        statusMessage += '<div style="color: green; font-weight: bold; margin-top: 10px;">🎉 成功解决"只检测2个异常点"的问题!</div>';
                    } else {
                        statusMessage += '<div style="color: orange; margin-top: 10px;">⚠️ 异常点数量仍然较少，建议调整参数</div>';
                    }

                    statusDiv.innerHTML = statusMessage;

                    // 更新统计显示
                    document.getElementById('anomalyCount').textContent = anomalyCount;
                    document.getElementById('anomalyRate').textContent = anomalyRate + '%';
                    document.getElementById('detectionTime').textContent = executionTime + 's';
                    document.getElementById('manualDetected').textContent = '大数据集';

                    console.log('🎯 大数据集检测结果:', result);

                    // 🔧 重要修复：更新图表显示大数据集结果
                    if (result.outliers && result.outliers.length > 0) {
                        // 生成与检测使用的相同数据
                        const largeData = generateTestDataBySize(17952);
                        currentTestData = largeData;
                        currentDetectionResult = result;
                        
                        // 更新图表
                        updateChart(largeData, result.outliers, `大数据集检测结果 (${largeData.length}点)`);
                        
                        console.log('📈 图表已更新为大数据集结果');
                    }
                } else {
                    throw new Error(result.message || '检测失败');
                }

            } catch (error) {
                console.error('大数据集测试错误:', error);
                statusDiv.innerHTML = `<div style="color: red;">❌ 大数据集测试失败: ${error.message}</div>`;
            } finally {
                testBtn.disabled = false;
            }
        }

        // 调用NETS API进行检测
        async function runNETSDetection(r, k, w) {
            const statusDiv = document.getElementById('detectionStatus');
            const runBtn = document.getElementById('runDetection');
            
            try {
                statusDiv.innerHTML = '<div class="loading">🔄 正在运行NETS检测...</div>';
                runBtn.disabled = true;

                const startTime = Date.now();

                const response = await fetch(`${API_URL}/nets/java/detect`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        data: currentTestData,
                        params: {
                            R: r,
                            K: k,
                            W: w,
                            S: Math.floor(w / 10),
                            D: 1,
                            sD: 1,
                            nW: 1
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`API错误: ${response.status}`);
                }

                const result = await response.json();
                const endTime = Date.now();
                const executionTime = ((endTime - startTime) / 1000).toFixed(2);

                if (result.status === 'success') {
                    currentDetectionResult = result;
                    updateVisualization(result, executionTime);
                    statusDiv.innerHTML = `<div class="result-info">✅ 检测成功! 用时: ${executionTime}s</div>`;
                } else {
                    throw new Error(result.message || '检测失败');
                }

            } catch (error) {
                console.error('NETS检测错误:', error);
                statusDiv.innerHTML = `<div style="color: red;">❌ 检测失败: ${error.message}</div>`;
            } finally {
                runBtn.disabled = false;
            }
        }

        // 更新图表显示
        function updateChart(data, anomalies, title) {
            if (!chart) return;
            
            currentTestData = data;
            const labels = Array.from({length: data.length}, (_, i) => i);
            
            // 更新数据
            chart.data.labels = labels;
            chart.data.datasets[0].data = data; // 原始数据
            
            // 更新手动异常点（只对小数据集显示）
            if (data.length <= 1000) {
                chart.data.datasets[1].data = labels.map(i => [100, 200, 300].includes(i) ? data[i] : null);
            } else {
                chart.data.datasets[1].data = labels.map(() => null); // 大数据集不显示手动异常点
            }
            
            // 更新NETS检测异常点
            chart.data.datasets[2].data = labels.map(i => 
                anomalies && anomalies.includes(i) ? data[i] : null
            );
            
            // 更新标题
            chart.options.plugins.title.text = title || `NETS检测结果 (${data.length}点)`;
            
            chart.update();
            console.log(`📊 图表已更新: ${data.length}点数据, ${anomalies ? anomalies.length : 0}个异常点`);
        }

        // 更新可视化图表和统计信息
        function updateVisualization(result, executionTime) {
            const detectedAnomalies = result.outlier_indices || [];
            const labels = Array.from({length: 500}, (_, i) => i);

            // 更新统计信息
            document.getElementById('anomalyCount').textContent = result.outlier_count || 0;
            document.getElementById('anomalyRate').textContent = (result.anomaly_rate || 0).toFixed(1) + '%';
            document.getElementById('detectionTime').textContent = executionTime + 's';

            // 检查手动异常点检测情况
            const manualPositions = [100, 200, 300];
            const detectedManual = manualPositions.filter(pos => {
                return detectedAnomalies.some(idx => Math.abs(idx - pos) <= 25);
            });
            document.getElementById('manualDetected').textContent = `${detectedManual.length}/3`;

            // 更新参数显示
            const params = result.parameters || {};
            document.getElementById('currentParams').textContent = 
                `R=${params.R}, K=${params.K}, W=${params.W}`;

            // 更新图表数据
            chart.data.datasets[2].data = labels.map(i => 
                detectedAnomalies.includes(i) ? currentTestData[i] : null
            );

            // 更新图表标题
            chart.options.plugins.title.text = 
                `Java NETS 异常检测结果 - ${result.outlier_count}个异常点 (${(result.anomaly_rate || 0).toFixed(1)}%)`;

            chart.update();

            // 输出详细分析
            console.log('🎯 最新检测结果:');
            console.log('参数:', params);
            console.log('检测到的异常点:', detectedAnomalies);
            console.log('手动异常点检测成功:', detectedManual);
        }

        // 初始化图表
        function initializeChart() {
            currentTestData = generateTestDataBySize(500);  // 默认小数据集
            const labels = Array.from({length: 500}, (_, i) => i);

            // 初始的检测结果 (来自之前的实际检测)
            const initialAnomalies = [146, 367, 211, 199, 411, 478, 157, 468, 103, 461, 410, 275, 472, 386, 226, 242, 39, 90, 64, 450, 428, 224, 252, 368, 377, 383, 96, 27, 274, 364, 115, 21, 169, 238, 122, 132, 245, 213, 421, 190, 290, 100, 313, 210, 464, 432, 4, 3, 372, 419, 434, 69];

            // 创建图表数据
            const chartData = {
                labels: labels,
                datasets: [
                    {
                        label: '原始数据',
                        data: currentTestData,
                        borderColor: '#1976d2',
                        backgroundColor: 'rgba(25, 118, 210, 0.1)',
                        borderWidth: 1,
                        pointRadius: 0,
                        pointHoverRadius: 3
                    },
                    {
                        label: '手动异常点',
                        data: labels.map(i => [100, 200, 300].includes(i) ? currentTestData[i] : null),
                        borderColor: '#f44336',
                        backgroundColor: '#f44336',
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        showLine: false,
                        pointStyle: 'circle'
                    },
                    {
                        label: 'NETS检测异常点',
                        data: labels.map(() => null), // 初始化为空，等待检测结果
                        borderColor: '#ff9800',
                        backgroundColor: 'rgba(255, 152, 0, 0.8)', // 增加不透明度
                        pointRadius: 6, // 增大点的尺寸
                        pointHoverRadius: 10,
                        showLine: false,
                        pointStyle: 'triangle',
                        pointBorderWidth: 2, // 增加边框宽度
                        pointBorderColor: '#e65100' // 深色边框增强可见性
                    }
                ]
            };

            // 创建图表
            const ctx = document.getElementById('anomalyChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: '数据点索引'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: '数值'
                            }
                        }
                    },
                    plugins: {
                        title: {
                            display: true,
                            text: 'Java NETS 异常检测结果 - 请调整参数重新检测',
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    if ([100, 200, 300].includes(index)) {
                                        return '手动添加的异常点 (+5)';
                                    }
                                    if (context.dataset.label === 'NETS检测异常点' && context.parsed.y !== null) {
                                        return 'NETS检测到的异常点';
                                    }
                                    return '';
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        // 事件监听器
        document.addEventListener('DOMContentLoaded', function() {
            initializeChart();

            // 运行检测按钮
            document.getElementById('runDetection').addEventListener('click', function() {
                const datasetSize = parseInt(document.getElementById('datasetSize').value);
                const r = parseFloat(document.getElementById('rValue').value);
                const k = parseInt(document.getElementById('kValue').value);
                const w = parseInt(document.getElementById('wValue').value);
                
                if (r < 0.01 || r > 1 || k < 1 || k > 50 || w < 100 || w > 3000) {
                    alert('参数值超出有效范围!');
                    return;
                }
                
                // 重新生成对应大小的数据
                currentTestData = generateTestDataBySize(datasetSize);
                
                runNETSDetection(r, k, w);
            });

            // 大数据集测试按钮
            document.getElementById('testLargeDataset').addEventListener('click', testLargeDataset);

            // 重置参数按钮
            document.getElementById('resetParams').addEventListener('click', function() {
                document.getElementById('rValue').value = 0.1;
                document.getElementById('kValue').value = 8;
                document.getElementById('wValue').value = 500;
                document.getElementById('presetParams').value = '';
            });

            // 预设参数选择
            document.getElementById('presetParams').addEventListener('change', function() {
                const preset = this.value;
                if (preset) {
                    const [r, k, w] = preset.split(',').map(x => parseFloat(x));
                    document.getElementById('rValue').value = r;
                    document.getElementById('kValue').value = k;
                    document.getElementById('wValue').value = w;
                }
            });
        });
    </script>
</body>
</html>
