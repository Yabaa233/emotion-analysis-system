<!DOCTYPE html>
<html>
<head>
    <title>Chart.js 异常点可视化测试</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: Arial; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .chart-container { width: 100%; height: 400px; margin: 20px 0; background: #2a2a2a; padding: 10px; border-radius: 5px; }
        .controls { margin: 20px 0; }
        button { padding: 8px 16px; margin: 5px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #5855eb; }
        .stats { background: #333; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .stat-item { background: #444; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>📊 Chart.js 异常点可视化测试</h1>
        
        <div class="controls">
            <button onclick="generateGSRData()">生成GSR数据</button>
            <button onclick="detectAnomalies()">检测异常</button>
            <button onclick="showNormalPoints()">显示正常点</button>
            <button onclick="showAnomalyPoints()">显示异常点</button>
            <button onclick="showBothLayers()">显示所有点</button>
            <button onclick="clearChart()">清空图表</button>
        </div>
        
        <div class="stats" id="dataStats"></div>
        
        <div class="chart-container">
            <canvas id="testChart"></canvas>
        </div>
        
        <div class="controls">
            <label>异常点大小: <input type="range" id="anomalySize" min="1" max="10" value="6" onchange="updateAnomalyDisplay()"></label>
            <label>正常点大小: <input type="range" id="normalSize" min="1" max="8" value="3" onchange="updateNormalDisplay()"></label>
            <label>透明度: <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="0.8" onchange="updateOpacity()"></label>
        </div>
    </div>

    <script>
        let chart = null;
        let gsrData = [];
        let anomalyIndices = [];
        let normalData = [];
        let anomalyData = [];
        
        // 初始化图表
        function initChart() {
            const ctx = document.getElementById('testChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: '时间 (秒)' },
                            grid: { color: '#444' }
                        },
                        y: {
                            type: 'linear',
                            title: { display: true, text: 'GSR 值' },
                            grid: { color: '#444' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
        }
        
        function generateGSRData() {
            console.log('🔄 生成GSR测试数据...');
            gsrData = [];
            
            // 生成类似真实数据的GSR序列
            const totalPoints = 2000; // 增加数据点数量来模拟真实情况
            const timeStep = 0.05; // 20Hz采样率
            
            for (let i = 0; i < totalPoints; i++) {
                const time = i * timeStep;
                
                // 基础信号 + 噪声
                let gsr = 0.6 + 0.1 * Math.sin(time * 0.5) + 0.02 * Math.random();
                
                // 添加一些突发事件
                if (Math.random() < 0.02) { // 2%概率
                    gsr += 0.1 + 0.1 * Math.random();
                }
                
                gsrData.push({ x: time, y: gsr });
            }
            
            updateStats();
            console.log(`✅ 生成了 ${gsrData.length} 个GSR数据点`);
        }
        
        async function detectAnomalies() {
            if (gsrData.length === 0) {
                alert('请先生成GSR数据');
                return;
            }
            
            console.log('🔍 开始异常检测...');
            
            try {
                // 准备API数据格式
                const apiData = gsrData.map(point => [point.y]);
                
                const response = await fetch('http://localhost:8080/anomaly/isolation_forest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: apiData,
                        contamination: 0.05, // 5%的异常率
                        random_state: 42
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    anomalyIndices = result.anomaly_indices;
                    
                    // 分离正常点和异常点
                    normalData = [];
                    anomalyData = [];
                    
                    gsrData.forEach((point, index) => {
                        if (anomalyIndices.includes(index)) {
                            anomalyData.push(point);
                        } else {
                            normalData.push(point);
                        }
                    });
                    
                    updateStats();
                    console.log(`✅ 检测完成: ${anomalyData.length} 个异常点, ${normalData.length} 个正常点`);
                } else {
                    console.error('❌ 异常检测失败:', result.error);
                }
            } catch (error) {
                console.error('❌ API请求失败:', error);
            }
        }
        
        function showNormalPoints() {
            if (normalData.length === 0) {
                alert('请先检测异常');
                return;
            }
            
            chart.data.datasets = [{
                label: '正常数据点',
                data: normalData,
                backgroundColor: 'rgba(34, 197, 94, 0.6)',
                borderColor: 'rgba(34, 197, 94, 1)',
                pointRadius: document.getElementById('normalSize').value,
                showLine: false
            }];
            
            chart.update('active');
            console.log(`📊 显示 ${normalData.length} 个正常点`);
        }
        
        function showAnomalyPoints() {
            if (anomalyData.length === 0) {
                alert('请先检测异常');
                return;
            }
            
            chart.data.datasets = [{
                label: '异常数据点',
                data: anomalyData,
                backgroundColor: 'rgba(239, 68, 68, 0.8)',
                borderColor: 'rgba(239, 68, 68, 1)',
                pointRadius: document.getElementById('anomalySize').value,
                showLine: false
            }];
            
            chart.update('active');
            console.log(`🚨 显示 ${anomalyData.length} 个异常点`);
            
            // 详细分析异常点分布
            analyzeAnomalyDistribution();
        }
        
        function showBothLayers() {
            if (normalData.length === 0 || anomalyData.length === 0) {
                alert('请先检测异常');
                return;
            }
            
            chart.data.datasets = [
                {
                    label: '正常数据点',
                    data: normalData,
                    backgroundColor: 'rgba(34, 197, 94, 0.4)',
                    borderColor: 'rgba(34, 197, 94, 0.8)',
                    pointRadius: document.getElementById('normalSize').value,
                    showLine: false
                },
                {
                    label: '异常数据点',
                    data: anomalyData,
                    backgroundColor: 'rgba(239, 68, 68, 0.9)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    pointRadius: document.getElementById('anomalySize').value,
                    showLine: false
                }
            ];
            
            chart.update('active');
            console.log(`📊 显示所有点: ${normalData.length} 正常 + ${anomalyData.length} 异常`);
        }
        
        function clearChart() {
            chart.data.datasets = [];
            chart.update();
            console.log('🗑️ 清空图表');
        }
        
        function updateAnomalyDisplay() {
            const size = document.getElementById('anomalySize').value;
            const dataset = chart.data.datasets.find(d => d.label === '异常数据点');
            if (dataset) {
                dataset.pointRadius = parseInt(size);
                chart.update('none');
            }
        }
        
        function updateNormalDisplay() {
            const size = document.getElementById('normalSize').value;
            const dataset = chart.data.datasets.find(d => d.label === '正常数据点');
            if (dataset) {
                dataset.pointRadius = parseInt(size);
                chart.update('none');
            }
        }
        
        function updateOpacity() {
            const opacity = document.getElementById('opacity').value;
            chart.data.datasets.forEach(dataset => {
                if (dataset.label === '正常数据点') {
                    dataset.backgroundColor = `rgba(34, 197, 94, ${opacity * 0.6})`;
                } else if (dataset.label === '异常数据点') {
                    dataset.backgroundColor = `rgba(239, 68, 68, ${opacity})`;
                }
            });
            chart.update('none');
        }
        
        function updateStats() {
            const statsDiv = document.getElementById('dataStats');
            
            let html = '<div class="stats-grid">';
            
            if (gsrData.length > 0) {
                const yValues = gsrData.map(p => p.y);
                const xValues = gsrData.map(p => p.x);
                
                html += `
                    <div class="stat-item">
                        <strong>总数据点</strong><br>
                        ${gsrData.length.toLocaleString()}
                    </div>
                    <div class="stat-item">
                        <strong>时间范围</strong><br>
                        ${Math.min(...xValues).toFixed(1)}s - ${Math.max(...xValues).toFixed(1)}s
                    </div>
                    <div class="stat-item">
                        <strong>GSR值范围</strong><br>
                        ${Math.min(...yValues).toFixed(3)} - ${Math.max(...yValues).toFixed(3)}
                    </div>
                `;
            }
            
            if (anomalyData.length > 0) {
                const anomalyY = anomalyData.map(p => p.y);
                html += `
                    <div class="stat-item">
                        <strong>异常点数量</strong><br>
                        ${anomalyData.length.toLocaleString()}
                    </div>
                    <div class="stat-item">
                        <strong>异常比例</strong><br>
                        ${((anomalyData.length / gsrData.length) * 100).toFixed(1)}%
                    </div>
                    <div class="stat-item">
                        <strong>异常值范围</strong><br>
                        ${Math.min(...anomalyY).toFixed(3)} - ${Math.max(...anomalyY).toFixed(3)}
                    </div>
                `;
            }
            
            html += '</div>';
            statsDiv.innerHTML = html;
        }
        
        function analyzeAnomalyDistribution() {
            if (anomalyData.length === 0) return;
            
            console.log('📈 异常点分布分析:');
            
            // 时间分布
            const timeGroups = {};
            anomalyData.forEach(point => {
                const timeSlot = Math.floor(point.x / 10) * 10; // 10秒区间
                timeGroups[timeSlot] = (timeGroups[timeSlot] || 0) + 1;
            });
            
            console.log('时间分布 (每10秒):', timeGroups);
            
            // 值分布
            const yValues = anomalyData.map(p => p.y).sort((a, b) => a - b);
            console.log(`值分布: 最小=${yValues[0].toFixed(3)}, 中位=${yValues[Math.floor(yValues.length/2)].toFixed(3)}, 最大=${yValues[yValues.length-1].toFixed(3)}`);
            
            // 检查点密度
            const totalTimeSpan = Math.max(...anomalyData.map(p => p.x)) - Math.min(...anomalyData.map(p => p.x));
            const density = anomalyData.length / totalTimeSpan;
            console.log(`异常点密度: ${density.toFixed(2)} 点/秒`);
            
            if (density > 1) {
                console.warn('⚠️ 异常点密度很高，可能导致视觉重叠');
            }
        }
        
        // 页面加载时初始化
        window.onload = function() {
            initChart();
            console.log('📊 Chart.js 测试环境初始化完成');
        };
    </script>
</body>
</html>