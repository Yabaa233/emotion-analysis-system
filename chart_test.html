<!DOCTYPE html>
<html>
<head>
    <title>Chart.js å¼‚å¸¸ç‚¹å¯è§†åŒ–æµ‹è¯•</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: Arial; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .chart-container { width: 100%; height: 400px; margin: 20px 0; background: #2a2a2a; padding: 10px; border-radius: 5px; }
        .controls { margin: 20px 0; }
        button { padding: 8px 16px; margin: 5px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #5855eb; }
        .stats { background: #333; padding: 15px; border-radius: 5px; margin: 10px 0; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .stat-item { background: #444; padding: 10px; border-radius: 3px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š Chart.js å¼‚å¸¸ç‚¹å¯è§†åŒ–æµ‹è¯•</h1>
        
        <div class="controls">
            <button onclick="generateGSRData()">ç”ŸæˆGSRæ•°æ®</button>
            <button onclick="detectAnomalies()">æ£€æµ‹å¼‚å¸¸</button>
            <button onclick="showNormalPoints()">æ˜¾ç¤ºæ­£å¸¸ç‚¹</button>
            <button onclick="showAnomalyPoints()">æ˜¾ç¤ºå¼‚å¸¸ç‚¹</button>
            <button onclick="showBothLayers()">æ˜¾ç¤ºæ‰€æœ‰ç‚¹</button>
            <button onclick="clearChart()">æ¸…ç©ºå›¾è¡¨</button>
        </div>
        
        <div class="stats" id="dataStats"></div>
        
        <div class="chart-container">
            <canvas id="testChart"></canvas>
        </div>
        
        <div class="controls">
            <label>å¼‚å¸¸ç‚¹å¤§å°: <input type="range" id="anomalySize" min="1" max="10" value="6" onchange="updateAnomalyDisplay()"></label>
            <label>æ­£å¸¸ç‚¹å¤§å°: <input type="range" id="normalSize" min="1" max="8" value="3" onchange="updateNormalDisplay()"></label>
            <label>é€æ˜åº¦: <input type="range" id="opacity" min="0.1" max="1" step="0.1" value="0.8" onchange="updateOpacity()"></label>
        </div>
    </div>

    <script>
        let chart = null;
        let gsrData = [];
        let anomalyIndices = [];
        let normalData = [];
        let anomalyData = [];
        
        // åˆå§‹åŒ–å›¾è¡¨
        function initChart() {
            const ctx = document.getElementById('testChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'æ—¶é—´ (ç§’)' },
                            grid: { color: '#444' }
                        },
                        y: {
                            type: 'linear',
                            title: { display: true, text: 'GSR å€¼' },
                            grid: { color: '#444' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: { color: '#fff' }
                        }
                    }
                }
            });
        }
        
        function generateGSRData() {
            console.log('ğŸ”„ ç”ŸæˆGSRæµ‹è¯•æ•°æ®...');
            gsrData = [];
            
            // ç”Ÿæˆç±»ä¼¼çœŸå®æ•°æ®çš„GSRåºåˆ—
            const totalPoints = 2000; // å¢åŠ æ•°æ®ç‚¹æ•°é‡æ¥æ¨¡æ‹ŸçœŸå®æƒ…å†µ
            const timeStep = 0.05; // 20Hzé‡‡æ ·ç‡
            
            for (let i = 0; i < totalPoints; i++) {
                const time = i * timeStep;
                
                // åŸºç¡€ä¿¡å· + å™ªå£°
                let gsr = 0.6 + 0.1 * Math.sin(time * 0.5) + 0.02 * Math.random();
                
                // æ·»åŠ ä¸€äº›çªå‘äº‹ä»¶
                if (Math.random() < 0.02) { // 2%æ¦‚ç‡
                    gsr += 0.1 + 0.1 * Math.random();
                }
                
                gsrData.push({ x: time, y: gsr });
            }
            
            updateStats();
            console.log(`âœ… ç”Ÿæˆäº† ${gsrData.length} ä¸ªGSRæ•°æ®ç‚¹`);
        }
        
        async function detectAnomalies() {
            if (gsrData.length === 0) {
                alert('è¯·å…ˆç”ŸæˆGSRæ•°æ®');
                return;
            }
            
            console.log('ğŸ” å¼€å§‹å¼‚å¸¸æ£€æµ‹...');
            
            try {
                // å‡†å¤‡APIæ•°æ®æ ¼å¼
                const apiData = gsrData.map(point => [point.y]);
                
                const response = await fetch('http://localhost:8080/anomaly/isolation_forest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: apiData,
                        contamination: 0.05, // 5%çš„å¼‚å¸¸ç‡
                        random_state: 42
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    anomalyIndices = result.anomaly_indices;
                    
                    // åˆ†ç¦»æ­£å¸¸ç‚¹å’Œå¼‚å¸¸ç‚¹
                    normalData = [];
                    anomalyData = [];
                    
                    gsrData.forEach((point, index) => {
                        if (anomalyIndices.includes(index)) {
                            anomalyData.push(point);
                        } else {
                            normalData.push(point);
                        }
                    });
                    
                    updateStats();
                    console.log(`âœ… æ£€æµ‹å®Œæˆ: ${anomalyData.length} ä¸ªå¼‚å¸¸ç‚¹, ${normalData.length} ä¸ªæ­£å¸¸ç‚¹`);
                } else {
                    console.error('âŒ å¼‚å¸¸æ£€æµ‹å¤±è´¥:', result.error);
                }
            } catch (error) {
                console.error('âŒ APIè¯·æ±‚å¤±è´¥:', error);
            }
        }
        
        function showNormalPoints() {
            if (normalData.length === 0) {
                alert('è¯·å…ˆæ£€æµ‹å¼‚å¸¸');
                return;
            }
            
            chart.data.datasets = [{
                label: 'æ­£å¸¸æ•°æ®ç‚¹',
                data: normalData,
                backgroundColor: 'rgba(34, 197, 94, 0.6)',
                borderColor: 'rgba(34, 197, 94, 1)',
                pointRadius: document.getElementById('normalSize').value,
                showLine: false
            }];
            
            chart.update('active');
            console.log(`ğŸ“Š æ˜¾ç¤º ${normalData.length} ä¸ªæ­£å¸¸ç‚¹`);
        }
        
        function showAnomalyPoints() {
            if (anomalyData.length === 0) {
                alert('è¯·å…ˆæ£€æµ‹å¼‚å¸¸');
                return;
            }
            
            chart.data.datasets = [{
                label: 'å¼‚å¸¸æ•°æ®ç‚¹',
                data: anomalyData,
                backgroundColor: 'rgba(239, 68, 68, 0.8)',
                borderColor: 'rgba(239, 68, 68, 1)',
                pointRadius: document.getElementById('anomalySize').value,
                showLine: false
            }];
            
            chart.update('active');
            console.log(`ğŸš¨ æ˜¾ç¤º ${anomalyData.length} ä¸ªå¼‚å¸¸ç‚¹`);
            
            // è¯¦ç»†åˆ†æå¼‚å¸¸ç‚¹åˆ†å¸ƒ
            analyzeAnomalyDistribution();
        }
        
        function showBothLayers() {
            if (normalData.length === 0 || anomalyData.length === 0) {
                alert('è¯·å…ˆæ£€æµ‹å¼‚å¸¸');
                return;
            }
            
            chart.data.datasets = [
                {
                    label: 'æ­£å¸¸æ•°æ®ç‚¹',
                    data: normalData,
                    backgroundColor: 'rgba(34, 197, 94, 0.4)',
                    borderColor: 'rgba(34, 197, 94, 0.8)',
                    pointRadius: document.getElementById('normalSize').value,
                    showLine: false
                },
                {
                    label: 'å¼‚å¸¸æ•°æ®ç‚¹',
                    data: anomalyData,
                    backgroundColor: 'rgba(239, 68, 68, 0.9)',
                    borderColor: 'rgba(239, 68, 68, 1)',
                    pointRadius: document.getElementById('anomalySize').value,
                    showLine: false
                }
            ];
            
            chart.update('active');
            console.log(`ğŸ“Š æ˜¾ç¤ºæ‰€æœ‰ç‚¹: ${normalData.length} æ­£å¸¸ + ${anomalyData.length} å¼‚å¸¸`);
        }
        
        function clearChart() {
            chart.data.datasets = [];
            chart.update();
            console.log('ğŸ—‘ï¸ æ¸…ç©ºå›¾è¡¨');
        }
        
        function updateAnomalyDisplay() {
            const size = document.getElementById('anomalySize').value;
            const dataset = chart.data.datasets.find(d => d.label === 'å¼‚å¸¸æ•°æ®ç‚¹');
            if (dataset) {
                dataset.pointRadius = parseInt(size);
                chart.update('none');
            }
        }
        
        function updateNormalDisplay() {
            const size = document.getElementById('normalSize').value;
            const dataset = chart.data.datasets.find(d => d.label === 'æ­£å¸¸æ•°æ®ç‚¹');
            if (dataset) {
                dataset.pointRadius = parseInt(size);
                chart.update('none');
            }
        }
        
        function updateOpacity() {
            const opacity = document.getElementById('opacity').value;
            chart.data.datasets.forEach(dataset => {
                if (dataset.label === 'æ­£å¸¸æ•°æ®ç‚¹') {
                    dataset.backgroundColor = `rgba(34, 197, 94, ${opacity * 0.6})`;
                } else if (dataset.label === 'å¼‚å¸¸æ•°æ®ç‚¹') {
                    dataset.backgroundColor = `rgba(239, 68, 68, ${opacity})`;
                }
            });
            chart.update('none');
        }
        
        function updateStats() {
            const statsDiv = document.getElementById('dataStats');
            
            let html = '<div class="stats-grid">';
            
            if (gsrData.length > 0) {
                const yValues = gsrData.map(p => p.y);
                const xValues = gsrData.map(p => p.x);
                
                html += `
                    <div class="stat-item">
                        <strong>æ€»æ•°æ®ç‚¹</strong><br>
                        ${gsrData.length.toLocaleString()}
                    </div>
                    <div class="stat-item">
                        <strong>æ—¶é—´èŒƒå›´</strong><br>
                        ${Math.min(...xValues).toFixed(1)}s - ${Math.max(...xValues).toFixed(1)}s
                    </div>
                    <div class="stat-item">
                        <strong>GSRå€¼èŒƒå›´</strong><br>
                        ${Math.min(...yValues).toFixed(3)} - ${Math.max(...yValues).toFixed(3)}
                    </div>
                `;
            }
            
            if (anomalyData.length > 0) {
                const anomalyY = anomalyData.map(p => p.y);
                html += `
                    <div class="stat-item">
                        <strong>å¼‚å¸¸ç‚¹æ•°é‡</strong><br>
                        ${anomalyData.length.toLocaleString()}
                    </div>
                    <div class="stat-item">
                        <strong>å¼‚å¸¸æ¯”ä¾‹</strong><br>
                        ${((anomalyData.length / gsrData.length) * 100).toFixed(1)}%
                    </div>
                    <div class="stat-item">
                        <strong>å¼‚å¸¸å€¼èŒƒå›´</strong><br>
                        ${Math.min(...anomalyY).toFixed(3)} - ${Math.max(...anomalyY).toFixed(3)}
                    </div>
                `;
            }
            
            html += '</div>';
            statsDiv.innerHTML = html;
        }
        
        function analyzeAnomalyDistribution() {
            if (anomalyData.length === 0) return;
            
            console.log('ğŸ“ˆ å¼‚å¸¸ç‚¹åˆ†å¸ƒåˆ†æ:');
            
            // æ—¶é—´åˆ†å¸ƒ
            const timeGroups = {};
            anomalyData.forEach(point => {
                const timeSlot = Math.floor(point.x / 10) * 10; // 10ç§’åŒºé—´
                timeGroups[timeSlot] = (timeGroups[timeSlot] || 0) + 1;
            });
            
            console.log('æ—¶é—´åˆ†å¸ƒ (æ¯10ç§’):', timeGroups);
            
            // å€¼åˆ†å¸ƒ
            const yValues = anomalyData.map(p => p.y).sort((a, b) => a - b);
            console.log(`å€¼åˆ†å¸ƒ: æœ€å°=${yValues[0].toFixed(3)}, ä¸­ä½=${yValues[Math.floor(yValues.length/2)].toFixed(3)}, æœ€å¤§=${yValues[yValues.length-1].toFixed(3)}`);
            
            // æ£€æŸ¥ç‚¹å¯†åº¦
            const totalTimeSpan = Math.max(...anomalyData.map(p => p.x)) - Math.min(...anomalyData.map(p => p.x));
            const density = anomalyData.length / totalTimeSpan;
            console.log(`å¼‚å¸¸ç‚¹å¯†åº¦: ${density.toFixed(2)} ç‚¹/ç§’`);
            
            if (density > 1) {
                console.warn('âš ï¸ å¼‚å¸¸ç‚¹å¯†åº¦å¾ˆé«˜ï¼Œå¯èƒ½å¯¼è‡´è§†è§‰é‡å ');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            initChart();
            console.log('ğŸ“Š Chart.js æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ');
        };
    </script>
</body>
</html>