<!DOCTYPE html>
<html>
<head>
    <title>å¼‚å¸¸æ£€æµ‹å¯è§†åŒ–æµ‹è¯•</title>
    <style>
        body { background: #1a1a1a; color: #fff; font-family: Arial; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #444; border-radius: 5px; }
        button { padding: 8px 16px; margin: 5px; background: #6366f1; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: #5855eb; }
        #testResults { font-family: monospace; font-size: 12px; background: #222; padding: 10px; margin-top: 10px; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>ğŸ” å¼‚å¸¸æ£€æµ‹å¯è§†åŒ–æµ‹è¯•å·¥å…·</h1>
    
    <div class="test-section">
        <h3>æµ‹è¯•APIè¿æ¥</h3>
        <button onclick="testApiConnection()">æµ‹è¯•APIå¥åº·çŠ¶æ€</button>
        <button onclick="testAnomalyApi()">æµ‹è¯•å¼‚å¸¸æ£€æµ‹API</button>
    </div>
    
    <div class="test-section">
        <h3>æµ‹è¯•æ•°æ®ç”Ÿæˆ</h3>
        <button onclick="generateTestData()">ç”Ÿæˆæµ‹è¯•GSRæ•°æ®</button>
        <button onclick="testAnomalyDetection()">æµ‹è¯•å¼‚å¸¸æ£€æµ‹</button>
        <button onclick="analyzeResults()">åˆ†æç»“æœ</button>
    </div>
    
    <div id="testResults"></div>

    <script>
        let testData = null;
        let detectionResults = null;
        
        function log(message) {
            const results = document.getElementById('testResults');
            results.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '\n';
            results.scrollTop = results.scrollHeight;
            console.log(message);
        }
        
        async function testApiConnection() {
            log('ğŸ”— æµ‹è¯•APIè¿æ¥...');
            try {
                const response = await fetch('http://localhost:8080/health');
                const result = await response.json();
                log('âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡: ' + JSON.stringify(result));
            } catch (error) {
                log('âŒ APIè¿æ¥å¤±è´¥: ' + error.message);
            }
        }
        
        async function testAnomalyApi() {
            log('ğŸ¤– æµ‹è¯•å¼‚å¸¸æ£€æµ‹API...');
            try {
                const response = await fetch('http://localhost:8080/anomaly/info');
                const result = await response.json();
                log('âœ… å¼‚å¸¸æ£€æµ‹APIå¯ç”¨: ' + JSON.stringify(result.available_algorithms));
            } catch (error) {
                log('âŒ å¼‚å¸¸æ£€æµ‹APIæµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }
        
        function generateTestData() {
            log('ğŸ“Š ç”Ÿæˆæµ‹è¯•GSRæ•°æ®...');
            
            // ç”Ÿæˆç±»ä¼¼çœŸå®GSRæ•°æ®çš„æµ‹è¯•æ•°æ®
            testData = [];
            const totalPoints = 1000;
            const startTime = 0;
            const timeStep = 0.1; // æ¯ä¸ªæ•°æ®ç‚¹é—´éš”0.1ç§’
            
            for (let i = 0; i < totalPoints; i++) {
                const time = startTime + i * timeStep;
                
                // åŸºç¡€GSRå€¼ï¼ˆåœ¨0.5-0.8ä¹‹é—´æ³¢åŠ¨ï¼‰
                let gsr = 0.65 + 0.1 * Math.sin(time * 0.1) + 0.05 * Math.random();
                
                // åœ¨æŸäº›æ—¶é—´ç‚¹æ·»åŠ å¼‚å¸¸å€¼
                if (i % 100 === 0 || i % 137 === 0) {
                    gsr += 0.2 + 0.1 * Math.random(); // å¼‚å¸¸é«˜å€¼
                }
                if (i % 83 === 0) {
                    gsr -= 0.15 + 0.05 * Math.random(); // å¼‚å¸¸ä½å€¼
                }
                
                testData.push([gsr]);
            }
            
            log(`âœ… ç”Ÿæˆäº† ${testData.length} ä¸ªæµ‹è¯•æ•°æ®ç‚¹`);
            log(`ğŸ“ˆ æ•°æ®èŒƒå›´: ${Math.min(...testData.map(d => d[0])).toFixed(3)} - ${Math.max(...testData.map(d => d[0])).toFixed(3)}`);
        }
        
        async function testAnomalyDetection() {
            if (!testData) {
                log('âŒ è¯·å…ˆç”Ÿæˆæµ‹è¯•æ•°æ®');
                return;
            }
            
            log('ğŸ” è¿è¡Œå¼‚å¸¸æ£€æµ‹...');
            try {
                const response = await fetch('http://localhost:8080/anomaly/isolation_forest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        data: testData,
                        contamination: 0.1,
                        random_state: 42
                    })
                });
                
                detectionResults = await response.json();
                
                if (detectionResults.status === 'success') {
                    log(`âœ… å¼‚å¸¸æ£€æµ‹å®Œæˆ:`);
                    log(`   - æ€»æ•°æ®ç‚¹: ${detectionResults.total_points}`);
                    log(`   - å¼‚å¸¸ç‚¹æ•°: ${detectionResults.anomaly_count}`);
                    log(`   - å¼‚å¸¸æ¯”ä¾‹: ${detectionResults.anomaly_percentage}%`);
                    log(`   - æ‰§è¡Œæ—¶é—´: ${detectionResults.execution_time}s`);
                } else {
                    log('âŒ å¼‚å¸¸æ£€æµ‹å¤±è´¥: ' + detectionResults.error);
                }
            } catch (error) {
                log('âŒ å¼‚å¸¸æ£€æµ‹è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }
        
        function analyzeResults() {
            if (!detectionResults || !testData) {
                log('âŒ è¯·å…ˆè¿è¡Œå¼‚å¸¸æ£€æµ‹');
                return;
            }
            
            log('ğŸ“‹ åˆ†ææ£€æµ‹ç»“æœ...');
            
            const anomalyIndices = detectionResults.anomaly_indices;
            const anomalyScores = detectionResults.anomaly_scores;
            
            // æ„å»ºå¼‚å¸¸ç‚¹æ•°æ®
            const anomalies = anomalyIndices.map(idx => ({
                index: idx,
                time: idx * 0.1, // å¯¹åº”æ—¶é—´
                value: testData[idx][0], // GSRå€¼
                score: anomalyScores[idx]
            }));
            
            log(`ğŸ¯ å¼‚å¸¸ç‚¹è¯¦æƒ…:`);
            anomalies.slice(0, 5).forEach((anomaly, i) => {
                log(`   ${i+1}. æ—¶é—´:${anomaly.time.toFixed(1)}s, å€¼:${anomaly.value.toFixed(3)}, åˆ†æ•°:${anomaly.score.toFixed(3)}`);
            });
            
            // åˆ†æå¼‚å¸¸ç‚¹åˆ†å¸ƒ
            const valueRange = {
                min: Math.min(...anomalies.map(a => a.value)),
                max: Math.max(...anomalies.map(a => a.value))
            };
            
            const timeRange = {
                min: Math.min(...anomalies.map(a => a.time)),
                max: Math.max(...anomalies.map(a => a.time))
            };
            
            log(`ğŸ“Š å¼‚å¸¸ç‚¹åˆ†å¸ƒ:`);
            log(`   - å€¼èŒƒå›´: ${valueRange.min.toFixed(3)} - ${valueRange.max.toFixed(3)}`);
            log(`   - æ—¶é—´èŒƒå›´: ${timeRange.min.toFixed(1)}s - ${timeRange.max.toFixed(1)}s`);
            
            // æ£€æŸ¥æ•°æ®å¯†åº¦
            const totalTime = (testData.length - 1) * 0.1;
            const density = anomalies.length / totalTime;
            log(`   - å¼‚å¸¸å¯†åº¦: ${density.toFixed(2)} å¼‚å¸¸ç‚¹/ç§’`);
            
            // å»ºè®®
            if (density > 10) {
                log('âš ï¸ å¼‚å¸¸ç‚¹å¯†åº¦å¾ˆé«˜ï¼Œå¯èƒ½åœ¨å›¾è¡¨ä¸Šé‡å æ˜¾ç¤º');
                log('ğŸ’¡ å»ºè®®: ä½¿ç”¨æ›´å°çš„ç‚¹å¤§å°æˆ–é™ä½contaminationå‚æ•°');
            }
            
            if (valueRange.max - valueRange.min < 0.1) {
                log('âš ï¸ å¼‚å¸¸ç‚¹å€¼èŒƒå›´å¾ˆå°ï¼Œå¯èƒ½åœ¨å›¾è¡¨ä¸Šéš¾ä»¥åŒºåˆ†');
                log('ğŸ’¡ å»ºè®®: æ£€æŸ¥Yè½´ç¼©æ”¾æˆ–ä½¿ç”¨ä¸åŒçš„è§†è§‰æ ·å¼');
            }
        }
    </script>
</body>
</html>